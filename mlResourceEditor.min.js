!function(a){"use strict";var b=a.forEach,c=a.isDefined,d=a.isUndefined,e=a.isObject,f=(a.isArray,a.isDate,a.isString),g=a.isFunction,h=a.fromJson,i=a.toJson,j=a.extend,k=a.merge,l=a.copy,m={title_list:"Resource manager",title_add:"Add a resource",title_edit:"Edit a resource",question_remove:"Do you want to remove this resource ?"},n=a.module("mlResourceEditor",["ngResource","ngMaterial"]);n.factory("mlUtils",function(){var a={rDateConvert:function(c){b(c,function(b,d){if(e(b))a.rDateConvert(b);else if(f(b)){var g=new Date(b);isNaN(g.getDate())||(c[d]=g)}})}};return a}),n.factory("mlResourceTransform",function(a){return{request:function(a){var d=i(a);return b(d,function(a,b){e(a)&&c(a.id)&&(d[b]=a.id)}),d},response:function(b){var c=h(b);return a.rDateConvert(c),c}}}),n.provider("mlResources",function(){var a=this.resources={},e=this.collections={},f=this.options={};this.addResource=function(a){var b=a.name;f[b]=a},this.$get=function(g,h,i,l,n){var p='<md-dialog class="md-dialog ml-resource-dialog"><md-dialog-content class="md-dialog-content"><div ng-hide="item">'+o+'</div><div ng-show="item" ml-resource-form></div></md-dialog-content></md-dialog>',q={init:function(){var c={query:{isArray:!0,method:"GET",transformResponse:n.response},update:{method:"PUT",transformRequest:n.request},save:{method:"POST",transformRequest:n.request}};b(f,function(b,d){var f={};k(f,c,b.actions),a[d]=g(b.url,b.url_params,f),e[d]=[],q.load(d)})},load:function(a){if(d(a))throw"The function load() from mlResources service requires the 'name' attribut.";var b=q.getResource(a),c=q.getCollection(a);b.query().$promise.then(function(a){c.length=0;for(var b=0;b<a.length;b++)c.push(a[b])},function(a){h.alert(a.statusText)})},getResource:function(b){return a[b]},getCollection:function(a){return e[a]},getOptions:function(a){return f[a]},displayInDialog:function(a){var b=q.getOptions(a),d=c(b.scope)?b.scope:i.$new();j(d,m,b),c(d.scope)&&(d.scope=void 0),d.formIsDialog=!1,d.close=function(){l.hide()},l.show({template:p,controller:"mlEditorController",scope:d,locals:{name:a,inline:!1},clickOutsideToClose:!0})}};return q}}),n.factory("mlFormDialog",function(a){var b={open:function(b){var c='<md-dialog class="md-dialog ml-resource-dialog"><md-dialog-content class="md-dialog-content">'+p+"</md-dialog-content></md-dialog>";a.show({template:c,controller:"mlFormController",clickOutsideToClose:!0,scope:b,preserveScope:!0})},close:function(){a.hide()}};return b}),n.directive("mlResourceEditor",function(a){return{restrict:"A",template:o,link:function(b,c,d){var e=d.name;b.formIsDialog=!0;var f={$scope:b,name:e,inline:!0};a("mlEditorController",f)}}}),n.directive("mlResourceList",function(){return{restrict:"A",link:function(a,b){a.itemSelected=function(){return null!=a.rowSelected?a.items[a.rowSelected]:null},b.find("tbody").on("click","tr",function(){$(this).siblings(".selected").removeClass("selected"),$(this).hasClass("selected")?($(this).removeClass("selected"),a.rowSelected=null):($(this).addClass("selected"),a.rowSelected=$(this).index()),a.$apply()})}}}),n.directive("mlResourceForm",function(){return{restrict:"A",template:p,controller:"mlFormController"}}),n.filter("inInputTypes",[function(){var a=["text","number"];return function(b){for(var c=0;c<a.length;c++)if(a[c]==b)return!0;return!1}}]),n.controller("mlEditorController",function(a,d,e,f,h,i,k){var n=f.getResource(i),o=f.getOptions(i);a.item=null,a.items=f.getCollection(i),a.loading=!1,a.rowSelected=null,a.inline=k,a.options=o,a.form_title="",a.name=i,j(a,m,o),this.create=function(){var d=new n;return b(a.fields,function(a){c(a.type)&&("date"===a.type?d[a.model]=new Date:"select"===a.type?d[a.model]=null:"number"===a.type?d[a.model]=0:"text"===a.type&&(d[a.model]=""))}),d};var p=this;a.add=function(){a.form_title=a.title_add,a.item=p.create(),!0===k&&h.open(a)},a.edit=function(){a.form_title=a.title_edit,a.item=l(a.itemSelected()),b(a.fields,function(d){if("select"===d.type&&c(d.select_resource)){var e=d.model,g=a.item[e].id;b(f.getCollection(d.select_resource.collection),function(b){b.id===g&&(a.item[e]=b)})}}),!0===k&&h.open(a)},a.remove=function(){if(d.confirm(a.question_remove)===!0){var b=a.itemSelected();b.$remove().then(function(){f.load(a.name)},function(a){d.alert(a.statusText)})["finally"](function(){a.rowSelected=null,a.confirm=null})}},a.getString=function(a,b){return g(a.to_string)?a.to_string(b):"date"===a.type&&c(a.date_format)?e("date")(b[a.model],a.date_format):b[a.model]}}),n.controller("mlFormController",function(b,d,e){var f=function(){b.item=null,!0===b.formIsDialog&&e.close()};b.cancel=f,b.submit=function(){a.isDefined(b.item.id)?b.item.$update().then(function(){d.load(b.name),b.rowSelected=null,f()},function(a){console.log(a)}):b.item.$save().then(function(){d.load(b.name),f()},function(a){console.log(a)})},b.getOptions=function(a){return c(a.select_resource)?d.getCollection(a.select_resource.collection):void 0},b.getOptionText=function(a,b){var c=(d.getOptions(a),a.select_resource.column);return b[c]}});var o='<i ng-if="inline != true" class="md-icon rm-close material-icons" ng-click="close()">close</i><div class="ml-resource-list"><div><table ml-resource-list><caption><span class="ml-list-title">{{ title_list }} <span class="loading" ng-show="loading">( Chargement en cours ... )</span></span><div class="rm-table-actions"><i class="md-icon material-icons green" ng-click="add()">add</i><i class="md-icon material-icons yellow" ng-disabled="rowSelected == null" ng-click="edit()">create</i><i class="md-icon material-icons red" ng-disabled="rowSelected == null" ng-click="remove()">delete</i></div></caption><thead><tr><th ng-repeat="field in fields">{{ field.label }}</th></tr></thead><tbody><tr ng-repeat="item in items"><td ng-repeat="field in fields">{{ getString(field, item) }}</td></tr></tbody></table></div><div ng-if="isDialog" class="md-actions"><md-button ng-click="hide()" class="md-primary md-raised rm-button">Fermer</md-button></div></div>',p='<i ng-if="inline != true" class="md-icon rm-close material-icons" ng-click="close()">close</i><div class="ml-form-title">{{ form_title }}</div><form name="rscform"><div ng-repeat="field in fields"><md-input-container class="md-block" ng-if="field.type|inInputTypes"><label>{{ field.label }}</label><input name="{{ field.model }}" type="{{ field.type }}" ng-model="item[field.model]" ng-required="field.required === true"/></md-input-container><md-input-container class="md-block" ng-if="field.type == \'select\'"><label>{{ field.label }}</label><md-select ng-model="item[field.model]" ng-required="field.required === true"><md-option ng-repeat="option in getOptions(field)" ng-value="option">{{ getOptionText(field, option) }}</md-option></md-select></md-input-container><div ng-if="field.type == \'date\'"><md-datepicker ng-model="item[field.model]" md-placeholder="{{ field.label }}" ng-required="field.required === true" aria-label="datetime"></md-datepicker></div><md-input-container class="md-block" ng-if="field.type == \'textarea\'"><label>{{ field.label }}</label><textarea ng-model="item[field.model]" columns="1" md-max-length="150"></textarea></md-input-container></div><div class="md-actions"><md-button class="md-accent md-raised rm-button" ng-click="cancel()">Annuler</md-button><md-button class="md-primary md-raised rm-button" type="submit" ng-click="submit()">Ok</md-button></div></form>'}(angular);