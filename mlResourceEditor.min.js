!function(a){"use strict";var b=a.forEach,c=a.isDefined,d=(a.isUndefined,a.isObject),e=(a.isArray,a.isDate,a.isString,a.isFunction),f=a.fromJson,g=a.toJson,h=a.extend,i={title_list:"Resource manager",title_add:"Add a resource",title_edit:"Edit a resource",question_remove:"Do you want to remove this resource ?"},j=a.module("mlResourceEditor",["ngResource","ngMaterial"]);j.factory("mlUtils",function(){var a=/(\d{4})\D?(0[1-9]|1[0-2])\D?([12]\d|0[1-9]|3[01])/,c=new RegExp(a),e={convertDates:function(a){b(a,function(b,f){d(b)?e.convertDates(b):!0===c.test(b)&&(a[f]=new Date(b))})}};return e}),j.factory("mlResourceTransformers",function(e){return{request:function(e){var f=a.copy(e);return b(f,function(a,b){d(a)&&c(a.id)&&(f[b]=a.id)}),g(f)},response:function(a){var b=f(a);return e.convertDates(b),b}}}),j.provider("mlResources",function(){var a=this.resources={},d=this.collections={},e=this.options={};this.addResource=function(a){var b=a.name;e[b]=a},this.$get=function(f,g,j,l,m){var n='<md-dialog class="md-dialog"><md-dialog-content class="md-dialog-content"><div ng-hide="item">'+k+'</div><div ng-show="item" ml-resource-form></div></md-dialog-content></md-dialog>',o={init:function(){b(e,function(b,c){a[c]=f(b.url,b.url_params,{query:{isArray:!0,method:"GET",transformResponse:m.response},get:{method:"GET",transformResponse:m.response},update:{method:"PUT",transformRequest:m.request},save:{method:"POST",transformRequest:m.request}}),d[c]=[],o.load(c)})},load:function(a){var b=o.getResource(a),c=o.getCollection(a);b.query().$promise.then(function(a){c.length=0;for(var b=0;b<a.length;b++)c.push(a[b])},function(a){g.alert(a.statusText)})},getResource:function(b){return a[b]},getCollection:function(a){return d[a]},getOptions:function(a){return e[a]},displayInDialog:function(a){var b=o.getOptions(a),d=c(b.scope)?b.scope:j.$new();h(d,i,b),c(d.scope)&&(d.scope=void 0),d.formIsDialog=!1,d.close=function(){l.hide()},l.show({template:n,controller:"mlEditorController",scope:d,locals:{name:a,inline:!1},clickOutsideToClose:!0})}};return o}}),j.factory("mlFormDialog",function(a){var b={open:function(b){var c='<md-dialog class="md-dialog"><md-dialog-content class="md-dialog-content">'+l+"</md-dialog-content></md-dialog>";a.show({template:c,controller:"mlFormController",clickOutsideToClose:!0,scope:b,preserveScope:!0})},close:function(){a.hide()}};return b}),j.directive("mlResourceEditor",function(a){return{restrict:"A",template:k,link:function(b,c,d){var e=d.name;b.formIsDialog=!0;var f={$scope:b,name:e,inline:!0};a("mlEditorController",f)}}}),j.directive("mlResourceList",function(){return{restrict:"A",link:function(a,b){a.itemSelected=function(){return null!=a.rowSelected?a.items[a.rowSelected]:null},b.find("tbody").on("click","tr",function(){$(this).siblings(".selected").removeClass("selected"),$(this).hasClass("selected")?($(this).removeClass("selected"),a.rowSelected=null):($(this).addClass("selected"),a.rowSelected=$(this).index()),a.$apply()})}}}),j.directive("mlResourceForm",function(){return{restrict:"A",template:l,controller:"mlFormController"}}),j.filter("inInputTypes",[function(){var a=["text","number"];return function(b){for(var c=0;c<a.length;c++)if(a[c]==b)return!0;return!1}}]),j.controller("mlEditorController",function(a,d,f,g,j,k,l){a.item=null,a.items=g.getCollection(k),a.loading=!1,a.form_title=null,a.rowSelected=null,a.inline=l;var m=g.getResource(k),n=g.getOptions(k);h(a,i,n),a.add=function(){a.form_title=a.title_add,a.item=new m,b(a.fields,function(b){"datetime"===b.type&&(a.item[b.model]=new Date)}),!0===l&&j.open(a)},a.edit=function(){a.form_title=a.title_edit,a.item=a.itemSelected(),b(a.fields,function(d){if("select"===d.type&&c(d.select_resource)){var e=d.model,f=a.item[e].id;b(g.getCollection(d.select_resource.collection),function(b){b.id===f&&(a.item[e]=b)})}}),!0===l&&j.open(a)},a.remove=function(){if(d.confirm(a.question_remove)===!0){var b=a.itemSelected();b.$remove().then(function(){CollectionHandler.load()},function(a){d.alert(a.statusText)})["finally"](function(){a.rowSelected=null,a.confirm=null})}},a.getString=function(a,b){return e(a.to_string)?a.to_string(b):"date"===a.type&&c(a.date_format)?f("date")(b[a.model],a.date_format):b[a.model]}}),j.controller("mlFormController",function(b,d,e){var f=function(){b.item=null,!0===b.formIsDialog&&e.close()};b.cancel=f,b.submit=function(){a.isDefined(b.item.id)?b.item.$update().then(function(){CollectionHandler.load(),b.rowSelected=null,f()},function(a){console.log(a)}):b.item.$save().then(function(){CollectionHandler.load(),f()},function(a){console.log(a)})},b.getOptions=function(a){return c(a.select_resource)?d.getCollection(a.select_resource.collection):void 0},b.getOptionText=function(a,b){var c=(d.getOptions(a),a.select_resource.column);return b[c]}});var k='<i ng-if="inline != true" class="md-icon rm-close material-icons" ng-click="close()">close</i><div class="rm-list"><div><table ml-resource-list><caption><span class="title">{{ title_list }} <span class="loading" ng-show="loading">( Chargement en cours ... )</span></span><div class="rm-table-actions"><i class="md-icon material-icons green" ng-click="add()">add</i><i class="md-icon material-icons yellow" ng-disabled="rowSelected == null" ng-click="edit()">create</i><i class="md-icon material-icons red" ng-disabled="rowSelected == null" ng-click="remove()">delete</i></div></caption><thead><tr><th ng-repeat="field in fields">{{ field.label }}</th></tr></thead><tbody><tr ng-repeat="item in items"><td ng-repeat="field in fields">{{ getString(field, item) }}</td></tr></tbody></table></div><div ng-if="isDialog" class="md-actions"><md-button ng-click="hide()" class="md-primary md-raised rm-button">Fermer</md-button></div></div>',l='<div><i ng-if="inline != true" class="md-icon rm-close material-icons" ng-click="close()">close</i><form name="rscform"><div ng-repeat="field in fields"><md-input-container ng-if="field.type|inInputTypes"><label>{{ field.label }}</label><input name="{{ field.model }}" type="{{ field.type }}" ng-model="item[field.model]" ng-required="field.required === true"/></md-input-container><md-input-container ng-if="field.type == \'select\'"><label>{{ field.label }}</label><md-select ng-model="item[field.model]" ng-required="field.required === true"><md-option ng-repeat="option in getOptions(field)" ng-value="option">{{ getOptionText(field, option) }}</md-option></md-select></md-input-container><div ng-if="field.type == \'date\'"><md-datepicker ng-model="item[field.model]" md-placeholder="{{ field.label }}" ng-required="field.required === true" aria-label="datetime"></md-datepicker></div><md-input-container ng-if="field.type == \'textarea\'"><label>{{ field.label }}</label><textarea ng-model="item[field.model]" columns="1" md-max-length="150"></textarea></md-input-container></div><div class="md-actions"><md-button class="md-accent md-raised rm-button gray" ng-click="cancel()">Annuler</md-button><md-button class="md-primary md-raised rm-button green" type="submit" ng-click="submit()">Ok</md-button></div></form></div>'}(angular);