!function(a){"use strict";var b=a.forEach,c=a.isDefined,d=(a.isUndefined,a.isObject),e=(a.isArray,a.isDate,a.isString,a.isFunction),f=(a.fromJson,a.toJson),g=a.extend,h={title_list:"Resource manager",title_add:"Add a resource",title_edit:"Edit a resource",question_remove:"Do you want to remove this resource ?"},i={request:function(e){var g=a.copy(e);return b(g,function(a,b){d(a)&&c(a.id)&&(g[b]=a.id)}),f(g)}},j=a.module("mlResourceEditor",["ngResource","ngMaterial"]);j.provider("mlResources",function(){var a=this.resources={},d=this.collections={},e=this.options={};this.addResource=function(a){var b=a.name;e[b]=a},this.$get=["$resource","$window","$rootScope","$mdDialog",function(f,j,l,m){var n='<md-dialog class="md-dialog"><md-dialog-content><div ng-hide="item">'+k+'</div><div ng-show="item" ml-resource-form></div></md-dialog-content></md-dialog>',o={init:function(){b(e,function(b,c){a[c]=f(b.url,b.url_params,{query:{isArray:!0,method:"GET"},get:{method:"GET"},update:{method:"PUT",transformRequest:i.request},save:{method:"POST",transformRequest:i.request}}),d[c]=[],o.load(c)})},load:function(a){var b=o.getResource(a),c=o.getCollection(a);b.query().$promise.then(function(a){c.length=0;for(var b=0;b<a.length;b++)c.push(a[b])},function(a){j.alert(a.statusText)})},getResource:function(b){return a[b]},getCollection:function(a){return d[a]},getOptions:function(a){return e[a]},displayInDialog:function(a){var b=o.getOptions(a),d=c(b.scope)?b.scope:l.$new();g(d,h,b),c(d.scope)&&(d.scope=void 0),d.formIsDialog=!1,m.show({template:n,controller:"mlEditorController",scope:d,locals:{name:a,inline:!1},clickOutsideToClose:!0})}};return o}]}),j.factory("mlFormDialog",["$mdDialog",function(a){var b={open:function(b){var c='<md-dialog class="md-dialog"><md-dialog-content>'+l+"</md-dialog-content></md-dialog>";a.show({template:c,controller:"mlFormController",clickOutsideToClose:!0,scope:b,preserveScope:!0})},close:function(){a.hide()}};return b}]),j.directive("mlResourceEditor",["$controller",function(a){return{restrict:"A",template:k,link:function(b,c,d){var e=d.name;b.formIsDialog=!0;var f={$scope:b,name:e,inline:!0};a("mlEditorController",f)}}}]),j.directive("mlResourceList",function(){var a=function(){return null!=$scope.rowSelected?$scope.items[$scope.rowSelected]:null};return{restrict:"A",link:function(b,c){b.itemSelected=a,c.find("tbody").on("click","tr",function(){$(this).siblings(".selected").removeClass("selected"),$(this).hasClass("selected")?($(this).removeClass("selected"),b.rowSelected=null):($(this).addClass("selected"),b.rowSelected=$(this).index()),b.$apply()})}}}),j.directive("mlResourceForm",function(){return{restrict:"A",template:l,controller:"mlFormController"}}),j.filter("inInputTypes",[function(){var a=["text","number"];return function(b){for(var c=0;c<a.length;c++)if(a[c]==b)return!0;return!1}}]),j.controller("mlEditorController",["$scope","$window","$filter","mlResources","mlFormDialog","name","inline",function(a,d,f,i,j,k,l){a.item=null,a.items=i.getCollection(k),a.loading=!1,a.form_title=null,a.rowSelected=null;var m=i.getResource(k),n=i.getOptions(k);g(a,h,n),a.add=function(){a.form_title=a.title_add,a.item=new m,b(a.fields,function(b){"datetime"===b.type&&(a.item[b.model]=new Date)}),!0===l&&j.open(a)},a.edit=function(){a.form_title=a.title_edit,a.item=a.itemSelected(),b(a.fields,function(d){if("select"===d.type&&c(d.options)){var e=d.model,f=a.item[e].id;b(d.options,function(b){b.id===f&&(a.item[e]=b)})}}),!0===l&&j.open(a)},a.remove=function(){if(d.confirm(a.question_remove)===!0){var b=a.itemSelected();b.$remove().then(function(){CollectionHandler.load()},function(a){d.alert(a.statusText)})["finally"](function(){a.rowSelected=null,a.confirm=null})}},a.getString=function(a,b){return e(a.to_string)?a.to_string(b):"datetime"===a.type&&c(a.date_format)?f("date")(b[a.model],"dd/MM/yyyy"):b[a.model]}}]),j.controller("mlFormController",["$scope","mlResources","mlFormDialog",function(b,d,e,f){var g=function(){b.item=null,!0===b.formIsDialog&&e.close()};b.cancel=g,b.submit=function(){a.isDefined(b.item.id)?b.item.$update().then(function(){CollectionHandler.load(),b.rowSelected=null,g()},function(a){console.log(a)}):b.item.$save().then(function(){CollectionHandler.load(),g()},function(a){console.log(a)})},b.getOptions=function(a){return c(a.select_resource)?d.getCollection(a.select_resource.collection):void 0},b.getOptionText=function(a,b){var c=(service.getOptions(a),a.select_resource.column);return b[c]}}]);var k='<i ng-if="inline != true" class="md-icon rm-close material-icons" ng-click="close()">close</i><div class="rm-list"><div><table ng-resource-list><caption><span class="title">{{ title_list }} <span class="loading" ng-show="loading">( Chargement en cours ... )</span></span><div class="rm-table-actions"><i class="md-icon material-icons green" ng-click="add()">add</i><i class="md-icon material-icons yellow" ng-disabled="rowSelected == null" ng-click="edit()">create</i><i class="md-icon material-icons red" ng-disabled="rowSelected == null" ng-click="remove()">delete</i></div></caption><thead><tr><th ng-repeat="field in fields">{{ field.label }}</th></tr></thead><tbody><tr ng-repeat="item in items"><td ng-repeat="field in fields">{{ getString(field, item) }}</td></tr></tbody></table></div><div ng-if="isDialog" class="md-actions"><md-button ng-click="hide()" class="md-primary md-raised rm-button">Fermer</md-button></div></div>',l='<div><i ng-if="inline != true" class="md-icon rm-close material-icons" ng-click="close()">close</i><form name="rscform"><div ng-repeat="field in fields"><md-input-container ng-if="field.type|inInputTypes"><label>{{ field.label }}</label><input name="{{ field.model }}" type="{{ field.type }}" ng-model="item[field.model]" ng-required="field.required === true"/></md-input-container><md-input-container ng-if="field.type == \'select\'"><label>{{ field.label }}</label><md-select ng-model="item[field.model]" ng-required="field.required === true"><md-option ng-repeat="option in getOptions(field)" ng-value="option">{{ getOptionText(field, option) }}</md-option></md-select></md-input-container><div ng-if="field.type == \'datetime\'"><md-datepicker ng-model="item[field.model]" md-placeholder="{{ field.label }}" ng-required="field.required === true" aria-label="datetime"></md-datepicker></div><md-input-container ng-if="field.type == \'textarea\'"><label>{{ field.label }}</label><textarea ng-model="item[field.model]" columns="1" md-max-length="150"></textarea></md-input-container></div><div class="md-actions"><md-button class="md-accent md-raised rm-button gray" ng-click="cancel()">Annuler</md-button><md-button class="md-primary md-raised rm-button green" type="submit" ng-click="submit()">Ok</md-button></div></form></div>'}(angular);